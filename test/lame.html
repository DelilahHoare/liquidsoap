<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Lame Test</title>
<script language="javascript" type="text/javascript">
  var wsUri = "ws://localhost:1234/";
  var websocket = new WebSocket(wsUri);
  websocket.onopen = function(evt) {
    console.log("Websocket connected.");
    websocket.send(JSON.stringify({"type": "hello", "data": {"mime": "audio/x-raw,format=F32LE,channels=2,layout=interleaved,rate=44100", "mount": "/mount"}}));
  };
  websocket.onclose = function(evt) { console.log("Websocket disconnected."); };
  websocket.onmessage = function(evt) { console.log("Websocket message: " + evt.data); };
  websocket.onerror = function(evt) { console.log("Websocket error: " + evt.data) };


  var audioContext;
  if (typeof webkitAudioContext !== "undefined") { audioContext = new webkitAudioContext(); }
  else { audioContext = new AudioContext(); };

  var buflen = 4096;

  function onAudioProcess(e) {
    var buf0 = e.inputBuffer.getChannelData(0);
    var buf1 = e.inputBuffer.getChannelData(0);
    var len = buf0.length;
    var buf = new Array();
    for (i = 0; i < buflen; i++) { buf[2*i] = buf0[i]; buf[2*i+1] = buf1[i] };
    console.log("Got buffer.");
    websocket.send(buf);
  }

  function onStream(stream) {
    console.log("Got stream.");
    var mediaStreamSource = audioContext.createMediaStreamSource(stream);
    console.log("Created source.");

    // Create buffer processor
    var node = audioContext.createJavaScriptNode(buflen, 2, 2);
    console.log("Created node.");

    mediaStreamSource.connect(node);
    node.onaudioprocess = onAudioProcess;
    node.connect(audioContext.destination);
    console.log("Connected.");
  }

  function init() {
    console.log("Initializing.");
    var recordAudio = document.getElementById('record-audio');

    recordAudio.onclick = function () {
      console.log("Clicked.");
      navigator.webkitGetUserMedia({audio:true, video:false}, onStream, function(e) { console.log("getUserMedia error: "+e.name+" "+e.message); });
    };
  }

  window.addEventListener("load", init, false);
</script>

<h2>Lame Test</h2>
<button id="record-audio">Record</button>
<div id="output"></div>
</html>
